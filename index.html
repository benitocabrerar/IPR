<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Curva IPR y VFP - Análisis de Desempeño de un Pozo Petrolero</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly JS -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Math.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.min.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <style>
        /* Estilos CSS */
        body {
            background-color: #f7f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h2, h3 {
            color: #2c3e50;
        }
        .container {
            margin-top: 20px;
        }
        .form-control, .form-select {
            font-size: 0.85em;
        }
        .form-group label {
            font-weight: bold;
            color: #34495e;
        }
        .error-message {
            color: red;
            font-size: 0.75em;
        }
        .input-error {
            border-color: red;
        }
        .results-table th, .results-table td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.75em;
        }
        .results-table th {
            background-color: #ecf0f1;
        }
        /* Añadir estilos adicionales según sea necesario */
        .export-buttons {
            margin-top: 20px;
        }
        .footer {
            margin-top: 50px;
            padding: 20px;
            background-color: #ecf0f1;
            text-align: center;
        }
        /* Custom styles for the graph */
        .plotly .xtick > text, .plotly .ytick > text {
            fill: black !important;
        }
        /* Style for compact form */
        .compact-form .form-group {
            margin-right: 10px;
            margin-bottom: 10px;
            flex: 1 1 100px;
            min-width: 100px;
        }
        .compact-form {
            display: flex;
            flex-wrap: wrap;
        }
        .section-title {
            background-color: #2980b9;
            color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        /* Style for surprise design */
        .surprise-design {
            border: 2px dashed #2980b9;
            padding: 15px;
            border-radius: 10px;
            background-color: #eaf2f8;
        }
        /* Estilos para tablas compactas */
        .compact-table {
            font-size: 0.7em;
            margin-bottom: 0;
        }
        .compact-table th, .compact-table td {
            padding: 2px 4px;
            text-align: center;
        }
        .compact-table thead {
            background-color: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }
        .compact-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .compact-table tbody tr:hover {
            background-color: #d1e7dd;
        }
        /* Estilos para tarjetas compactas */
        .compact-card {
            background-color: #ffffff;
            border: 1px solid #ced4da;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .compact-card .card-title {
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        .compact-card .table {
            margin-bottom: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Formulario de Entrada de Datos -->
    <div class="surprise-design mb-4">
        <h2>Análisis de Desempeño de un Pozo Petrolero</h2>
        <form id="inputForm">
            <div class="compact-form">
                <!-- Nombre del Analista -->
                <div class="form-group">
                    <label for="analyst_name">Nombre del Analista:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese su nombre completo."></i>
                    </label>
                    <input type="text" class="form-control" id="analyst_name" placeholder="Ingresa tu nombre" value="Ing. Benito Cabrera R.">
                </div>
                <!-- Fecha del Análisis -->
                <div class="form-group">
                    <label for="analysis_date">Fecha del Análisis:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Seleccione la fecha del análisis."></i>
                    </label>
                    <input type="date" class="form-control" id="analysis_date">
                </div>
                <!-- Nombre de la Empresa -->
                <div class="form-group">
                    <label for="company_name">Nombre de la Empresa:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese el nombre de la empresa."></i>
                    </label>
                    <input type="text" class="form-control" id="company_name" placeholder="Nombre de la empresa" value="PetroLatina S.A.">
                </div>
                <!-- Nombre del Pozo -->
                <div class="form-group">
                    <label for="well_name">Nombre del Pozo:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese el nombre del pozo."></i>
                    </label>
                    <input type="text" class="form-control" id="well_name" placeholder="Nombre del pozo" value="PL-123">
                </div>
                <!-- Nombre del Reservorio -->
                <div class="form-group">
                    <label for="reservoir_name">Nombre del Reservorio:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Ingrese el nombre del reservorio."></i>
                    </label>
                    <input type="text" class="form-control" id="reservoir_name" placeholder="Nombre del reservorio" value="Reservorio A">
                </div>
                <!-- Propiedades del Yacimiento -->
                <div class="form-group">
                    <label for="k">k (md):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Permeabilidad del yacimiento en milidarcies. Rango recomendado: 10 - 1000 md."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="k" value="100" min="0">
                    <div id="error_k" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="h">h (ft):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Espesor neto del yacimiento en pies. Rango recomendado: 10 - 200 ft."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="h" value="50" min="0">
                    <div id="error_h" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="p_avg">P_avg (psi):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Presión promedio del yacimiento en psi. Rango recomendado: 1000 - 5000 psi."></i>
                    </label>
                    <input type="number" class="form-control" id="p_avg" value="4000" min="0">
                    <div id="error_p_avg" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="re">re (ft):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Radio de drenaje en pies. Rango recomendado: 500 - 2000 ft."></i>
                    </label>
                    <input type="number" step="0.1" class="form-control" id="re" value="1000" min="0">
                    <div id="error_re" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="rw">rw (in):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Radio del pozo en pulgadas. Rango recomendado: 3 - 8 in."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="rw" value="4.5" min="0">
                    <div id="error_rw" class="error-message"></div>
                </div>
                <!-- Profundidad Total -->
                <div class="form-group">
                    <label for="MD">Profundidad Total (MD, ft):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Profundidad total medida del pozo en pies."></i>
                    </label>
                    <input type="number" class="form-control" id="MD" value="10000" min="0">
                    <div id="error_MD" class="error-message"></div>
                </div>
                <!-- Propiedades del Fluido -->
                <div class="form-group">
                    <label for="mu">μ (cp):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Viscosidad del fluido en centipoises. Rango recomendado: 0.2 - 10 cp."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="mu" value="0.95" min="0">
                    <div id="error_mu" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="GOR">GOR (SCF/bbl):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Relación Gas-Petróleo en SCF/bbl. Rango recomendado: 100 - 2000 SCF/bbl."></i>
                    </label>
                    <input type="number" class="form-control" id="GOR" value="675" min="0">
                    <div id="error_GOR" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="API">API:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Gravedad API del crudo. Rango recomendado: 10 - 70 grados API."></i>
                    </label>
                    <input type="number" class="form-control" id="API" value="35" min="0">
                    <div id="error_API" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="T">T (°F):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Temperatura del yacimiento en °F. Rango recomendado: 50 - 300 °F."></i>
                    </label>
                    <input type="number" class="form-control" id="T" value="180" min="50" max="300">
                    <div id="error_T" class="error-message"></div>
                </div>
                <!-- Tuberías -->
                <div class="form-group">
                    <label for="diametro1">D1 (in):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Diámetro de la tubería 1 en pulgadas. Rango recomendado: 1 - 12 in."></i>
                    </label>
                    <input type="number" step="0.001" class="form-control" id="diametro1" value="2.875" min="0">
                    <div id="error_diametro1" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="diametro2">D2 (in):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Diámetro de la tubería 2 en pulgadas. Rango recomendado: 1 - 12 in."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="diametro2" value="3.5" min="0">
                    <div id="error_diametro2" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="diametro3">D3 (in):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Diámetro de la tubería 3 en pulgadas. Rango recomendado: 1 - 12 in."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="diametro3" value="5.5" min="0">
                    <div id="error_diametro3" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="L">L (ft):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Longitud de la tubería en pies. Rango recomendado: 1000 - 15000 ft."></i>
                    </label>
                    <input type="number" class="form-control" id="L" value="10000" min="0">
                    <div id="error_L" class="error-message"></div>
                </div>
                <!-- Propiedades Adicionales -->
                <div class="form-group">
                    <label for="rho">ρ (lbm/ft³):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Densidad del fluido en lbm/ft³. Rango recomendado: 40 - 70 lbm/ft³."></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="rho" value="50" min="0">
                    <div id="error_rho" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="p_wh">p_wh (psi):
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Presión en la boca del pozo en psi. Rango recomendado: 100 - 1000 psi."></i>
                    </label>
                    <input type="number" class="form-control" id="p_wh" value="500" min="0">
                    <div id="error_p_wh" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="gamma_g">γ_g:
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Gravedad específica del gas. Rango recomendado: 0.55 - 1.0"></i>
                    </label>
                    <input type="number" step="0.01" class="form-control" id="gamma_g" value="0.65" min="0">
                    <div id="error_gamma_g" class="error-message"></div>
                </div>
                <!-- Selección de Correlaciones -->
                <div class="form-group">
                    <label for="bubble_correlation">Correlación P_b:</label>
                    <select class="form-select" id="bubble_correlation">
                        <option value="Standing">Standing</option>
                        <option value="Glaso">Glaso</option>
                        <option value="Vasquez-Beggs">Vasquez-Beggs</option>
                        <option value="Petrosky-Farshad">Petrosky-Farshad</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="viscosity_correlation">Correlación μ:</label>
                    <select class="form-select" id="viscosity_correlation">
                        <option value="Beal">Beal</option>
                        <option value="Beggs and Robinson">Beggs and Robinson</option>
                        <option value="Glaso">Glaso</option>
                        <option value="Petrosky and Farshad">Petrosky and Farshad</option>
                    </select>
                </div>
            </div>
        </form>
    </div>

    <!-- Gráfico -->
    <div id="plot" style="width: 100%; height: 600px;"></div>

    <!-- Pruebas de Producción -->
    <div class="surprise-design mb-4">
        <h3 class="section-title">Pruebas de Producción</h3>
        <!-- Prueba 1 -->
        <div class="compact-form">
            <div class="form-group">
                <label for="test1_date">Fecha Prueba 1:</label>
                <input type="date" class="form-control" id="test1_date" value="2023-01-15">
            </div>
            <div class="form-group">
                <label for="test1_qt">Caudal Total (bbl/d):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Rango típico: 100 - 2000 bbl/d."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test1_qt" value="800">
            </div>
            <div class="form-group">
                <label for="test1_bsw">BSW (%):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Basic Sediment and Water. Rango típico: 0 - 100%."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test1_bsw" value="30">
            </div>
            <div class="form-group">
                <label for="test1_pwf">Pwf (psi):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Presión en el fondo del pozo durante la prueba."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test1_pwf" value="2500">
            </div>
            <div class="form-group">
                <label for="test1_depth">Profundidad Sensor (ft):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Profundidad a la que se midió Pwf."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test1_depth" value="9500">
            </div>
            <div class="form-group">
                <label for="test1_notes">Anotaciones:</label>
                <input type="text" class="form-control" id="test1_notes" placeholder="Observaciones" value="Prueba inicial">
            </div>
        </div>
        <!-- Prueba 2 -->
        <div class="compact-form mt-3">
            <div class="form-group">
                <label for="test2_date">Fecha Prueba 2:</label>
                <input type="date" class="form-control" id="test2_date" value="2023-06-20">
            </div>
            <div class="form-group">
                <label for="test2_qt">Caudal Total (bbl/d):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Rango típico: 100 - 2000 bbl/d."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test2_qt" value="650">
            </div>
            <div class="form-group">
                <label for="test2_bsw">BSW (%):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Basic Sediment and Water. Rango típico: 0 - 100%."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test2_bsw" value="40">
            </div>
            <div class="form-group">
                <label for="test2_pwf">Pwf (psi):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Presión en el fondo del pozo durante la prueba."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test2_pwf" value="2200">
            </div>
            <div class="form-group">
                <label for="test2_depth">Profundidad Sensor (ft):
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Profundidad a la que se midió Pwf."></i>
                </label>
                <input type="number" step="0.01" class="form-control" id="test2_depth" value="9500">
            </div>
            <div class="form-group">
                <label for="test2_notes">Anotaciones:</label>
                <input type="text" class="form-control" id="test2_notes" placeholder="Observaciones" value="Prueba de seguimiento">
            </div>
        </div>
    </div>

    <!-- Resultados de los Cálculos -->
    <div class="surprise-design mb-4">
        <h3 class="section-title">Resultados de los Cálculos</h3>
        <!-- Tabla de Resultados -->
        <div class="table-responsive">
            <table class="table table-bordered results-table">
                <thead>
                    <tr>
                        <th>Parámetro</th>
                        <th>Valor</th>
                        <th>Unidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Presión de Burbuja Seleccionada (P<sub>b</sub>)</td>
                        <td id="presion_burbuja">-</td>
                        <td>psi</td>
                    </tr>
                    <tr>
                        <td>Caudal de Burbuja (q<sub>b</sub>)</td>
                        <td id="caudal_burbuja">-</td>
                        <td>bbl/día</td>
                    </tr>
                    <tr>
                        <td>Índice de Productividad Simplificado (PI<sub>simplificado</sub>)</td>
                        <td id="indice_productividad_simplificado">-</td>
                        <td>bbl/(día·psi)</td>
                    </tr>
                    <tr>
                        <td>Índice de Productividad Complejo (PI<sub>complejo</sub>)</td>
                        <td id="indice_productividad_complejo">-</td>
                        <td>bbl/(día·psi)</td>
                    </tr>
                    <tr>
                        <td>Caudal Máximo del Pozo (q<sub>max</sub>)</td>
                        <td id="caudal_maximo">-</td>
                        <td>bbl/día</td>
                    </tr>
                    <tr>
                        <td>Viscosidad (μ)</td>
                        <td id="viscosidad">-</td>
                        <td>cp</td>
                    </tr>
                    <tr>
                        <td>Número de Reynolds (Re)</td>
                        <td id="reynolds">-</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Factor de no-Darcy (f<sub>D</sub>)</td>
                        <td id="f_darcy">-</td>
                        <td></td>
                    </tr>
                    <!-- Reemplazo: Parámetros de operación del pozo -->
                    <tr>
                        <td>Parámetros de operación del pozo</td>
                        <td id="natural_flow_result">-</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sección de Curvas Dinámicas -->
    <div class="surprise-design mb-4">
        <h3 class="section-title">Curvas IPR y VFP</h3>
        <div class="row">
            <!-- Tarjeta IPR -->
            <div class="col-12 col-md-3 mb-3">
                <div class="card compact-card">
                    <div class="card-body p-2">
                        <h5 class="card-title text-center">Curva IPR</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover compact-table">
                                <thead>
                                    <tr>
                                        <th>Caudal (bbl/día)</th>
                                        <th>Presión (psi)</th>
                                    </tr>
                                </thead>
                                <tbody id="ipr_data_table">
                                    <!-- Filas dinámicas de IPR -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tarjeta VFP 1 -->
            <div class="col-12 col-md-3 mb-3">
                <div class="card compact-card">
                    <div class="card-body p-2">
                        <h5 class="card-title text-center">Curva VFP - D1</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover compact-table">
                                <thead>
                                    <tr>
                                        <th>Caudal (bbl/día)</th>
                                        <th>Presión (psi)</th>
                                    </tr>
                                </thead>
                                <tbody id="vfp1_data_table">
                                    <!-- Filas dinámicas de VFP1 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tarjeta VFP 2 -->
            <div class="col-12 col-md-3 mb-3">
                <div class="card compact-card">
                    <div class="card-body p-2">
                        <h5 class="card-title text-center">Curva VFP - D2</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover compact-table">
                                <thead>
                                    <tr>
                                        <th>Caudal (bbl/día)</th>
                                        <th>Presión (psi)</th>
                                    </tr>
                                </thead>
                                <tbody id="vfp2_data_table">
                                    <!-- Filas dinámicas de VFP2 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tarjeta VFP 3 -->
            <div class="col-12 col-md-3 mb-3">
                <div class="card compact-card">
                    <div class="card-body p-2">
                        <h5 class="card-title text-center">Curva VFP - D3</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover compact-table">
                                <thead>
                                    <tr>
                                        <th>Caudal (bbl/día)</th>
                                        <th>Presión (psi)</th>
                                    </tr>
                                </thead>
                                <tbody id="vfp3_data_table">
                                    <!-- Filas dinámicas de VFP3 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección Oculta: Coeficientes de Ajuste -->
    <div class="surprise-design mb-4 d-none">
        <h3 class="section-title">Coeficientes de Ajuste</h3>
        <!-- Tabla de Coeficientes -->
        <div class="table-responsive">
            <table class="table table-bordered results-table">
                <thead>
                    <tr>
                        <th>Curva</th>
                        <th>Coeficientes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Curva IPR</td>
                        <td id="coefficients_ipr">-</td>
                    </tr>
                    <tr>
                        <td>Curva VFP D1</td>
                        <td id="coefficients_vfp1">-</td>
                    </tr>
                    <tr>
                        <td>Curva VFP D2</td>
                        <td id="coefficients_vfp2">-</td>
                    </tr>
                    <tr>
                        <td>Curva VFP D3</td>
                        <td id="coefficients_vfp3">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sección Oculta: Intersecciones entre Curvas IPR y VFP -->
    <div class="surprise-design mb-4 d-none">
        <h3 class="section-title">Intersecciones entre Curvas IPR y VFP</h3>
        <div class="table-responsive">
            <table class="table table-bordered results-table">
                <thead>
                    <tr>
                        <th>Diámetro (in)</th>
                        <th>Caudal de Intersección (bbl/día)</th>
                        <th>Presión de Intersección (psi)</th>
                    </tr>
                </thead>
                <tbody id="intersections_table_body">
                    <!-- Filas dinámicas -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Botones de Exportación -->
<div class="export-buttons">
    <button type="button" class="btn btn-primary me-2" id="exportPDFButton" onclick="exportPDF()" aria-label="Exportar a PDF" disabled>Exportar a PDF</button>
    <button type="button" class="btn btn-success" id="exportExcelButton" onclick="exportExcel()" aria-label="Exportar a Excel" disabled>Exportar a Excel</button>
</div>

<!-- Formulario de Comentarios -->
<div class="surprise-design mt-4">
    <h3 class="section-title">Comentarios y Observaciones</h3>
    <form id="feedbackForm">
        <div class="mb-3">
            <label for="user_email" class="form-label">Tu Correo Electrónico (opcional):</label>
            <input type="email" class="form-control" id="user_email" placeholder="correo@ejemplo.com">
        </div>
        <div class="mb-3">
            <label for="user_feedback" class="form-label">Tus Comentarios:</label>
            <textarea class="form-control" id="user_feedback" rows="3" placeholder="Escribe tus comentarios aquí..."></textarea>
        </div>
        <button type="button" class="btn btn-info" onclick="submitFeedback()">Enviar Comentarios</button>
    </form>
</div>

<!-- Guía de Usuario -->
<div class="surprise-design mt-4">
    <h3 class="section-title">Guía de Usuario</h3>
    <p>Esta herramienta permite calcular y visualizar las curvas IPR (Índice de Productividad Relativo) y VFP (Presión en el Fondo del Pozo) para evaluar el desempeño de un pozo de petróleo. A continuación, se explica cada parámetro de entrada y su impacto en los resultados:</p>
    <ul>
        <li><strong>Permeabilidad (k, md):</strong> Medida de la capacidad del yacimiento para permitir el flujo de fluidos. Valores más altos indican una mayor facilidad para la producción.</li>
        <li><strong>Espesor neto (h, ft):</strong> Espesor de la formación productora. Un mayor espesor generalmente mejora la productividad del pozo.</li>
        <li><strong>Presión promedio del yacimiento (P_avg, psi):</strong> Presión en el yacimiento. Influye directamente en la tasa de producción.</li>
        <li><strong>Radio de drenaje (re, ft):</strong> Radio efectivo desde el pozo donde el yacimiento contribuye al flujo. Un mayor radio de drenaje puede aumentar la producción.</li>
        <li><strong>Viscosidad (μ, cp):</strong> Resistencia al flujo del fluido. Fluidos con mayor viscosidad son más difíciles de extraer.</li>
        <li><strong>Relación Gas-Petróleo (GOR, SCF/bbl):</strong> Cantidad de gas disuelto en el petróleo. Afecta la presión de burbuja y la composición del flujo.</li>
        <li><strong>Gravedad API del crudo:</strong> Medida de la densidad relativa del petróleo. Influye en la viscosidad y otras propiedades del fluido.</li>
        <li><strong>Temperatura del yacimiento (T, °F):</strong> Temperatura en el yacimiento. Afecta la viscosidad del fluido y las propiedades termodinámicas.</li>
        <li><strong>Diámetros de Tuberías (D1, D2, D3, in):</strong> Diámetros internos de las tuberías de producción en pulgadas. Influye en la velocidad del fluido y las pérdidas por fricción.</li>
        <li><strong>Longitud de la tubería (L, ft):</strong> Longitud total de la tubería desde el pozo hasta la superficie. A mayor longitud, mayores pérdidas por fricción.</li>
        <li><strong>Radio del pozo (rw, in):</strong> Radio efectivo del pozo en pulgadas. Debe ser menor que el radio de drenaje.</li>
        <li><strong>Densidad del fluido (ρ, lbm/ft³):</strong> Densidad del fluido de producción. Afecta el Número de Reynolds y las pérdidas por fricción.</li>
        <li><strong>Presión en la boca del pozo (p_wh, psi):</strong> Presión en la entrada de la tubería en la superficie. Influye en el caudal máximo del pozo.</li>
        <li><strong>Gravedad específica del gas (γ_g):</strong> Relación de la densidad del gas respecto al aire. Afecta las propiedades del flujo de gas.</li>
    </ul>
</div>

<!-- Pie de Página -->
<div class="footer">
    <p>Desarrollado por Ing. Benito Cabrera R. Derechos reservados 2024.</p>
</div>

</div>

<!-- Bootstrap JS y dependencias -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Función para formatear números con dos decimales
    function formatNumber(num) {
        return isNaN(num) ? '-' : num.toFixed(2);
    }

    // Función para mostrar mensajes de error
    function showError(fieldId, message) {
        document.getElementById(`error_${fieldId}`).innerText = message;
        document.getElementById(fieldId).classList.add('input-error');
    }

    // Función para limpiar mensajes de error
    function clearError(fieldId) {
        document.getElementById(`error_${fieldId}`).innerText = '';
        document.getElementById(fieldId).classList.remove('input-error');
    }

    // Función para validar entradas en tiempo real
    function validateInputs() {
        let isValid = true;

        // Obtener todos los valores de entrada
        const inputs = {
            k: parseFloat(document.getElementById("k").value),
            h: parseFloat(document.getElementById("h").value),
            p_avg: parseFloat(document.getElementById("p_avg").value),
            re: parseFloat(document.getElementById("re").value),
            mu: parseFloat(document.getElementById("mu").value),
            GOR: parseFloat(document.getElementById("GOR").value),
            API: parseFloat(document.getElementById("API").value),
            T: parseFloat(document.getElementById("T").value),
            diametro1: parseFloat(document.getElementById("diametro1").value),
            diametro2: parseFloat(document.getElementById("diametro2").value),
            diametro3: parseFloat(document.getElementById("diametro3").value),
            L: parseFloat(document.getElementById("L").value),
            rw: parseFloat(document.getElementById("rw").value),
            rho: parseFloat(document.getElementById("rho").value),
            p_wh: parseFloat(document.getElementById("p_wh").value),
            gamma_g: parseFloat(document.getElementById("gamma_g").value),
            MD: parseFloat(document.getElementById("MD").value)
        };

        // Validar cada campo individualmente
        for (let field in inputs) {
            if (isNaN(inputs[field])) {
                showError(field, `El valor debe ser un número.`);
                isValid = false;
            } else if (inputs[field] <= 0) {
                showError(field, `El valor debe ser un número positivo.`);
                isValid = false;
            } else {
                clearError(field);
            }
        }

        // Validar que rw < re (convertir rw de pulgadas a pies)
        let rw_ft = inputs['rw'] / 12; // Convertir pulgadas a pies
        if (rw_ft >= inputs['re']) {
            showError('rw', `Radio del pozo (rw) debe ser menor que el radio de drenaje (re).`);
            isValid = false;
        } else {
            clearError('rw');
        }

        // Validar rangos de API y T
        if (inputs['API'] < 10 || inputs['API'] > 70) {
            showError('API', `Gravedad API del crudo debe estar entre 10 y 70.`);
            isValid = false;
        }

        if (inputs['T'] < 50 || inputs['T'] > 300) {
            showError('T', `Temperatura del yacimiento debe estar entre 50°F y 300°F.`);
            isValid = false;
        }

        // Deshabilitar o habilitar los botones de exportación
        document.getElementById("exportPDFButton").disabled = !isValid;
        document.getElementById("exportExcelButton").disabled = !isValid;

        // Mostrar mensaje al pasar el mouse si los botones están deshabilitados
        if (!isValid) {
            document.getElementById("exportPDFButton").setAttribute('title', 'Corrija los errores para habilitar la exportación.');
            document.getElementById("exportExcelButton").setAttribute('title', 'Corrija los errores para habilitar la exportación.');
        } else {
            document.getElementById("exportPDFButton").removeAttribute('title');
            document.getElementById("exportExcelButton").removeAttribute('title');
        }

        return isValid;
    }

    // Función para calcular q_o (caudal de aceite) en las pruebas
    function calcularQo(qt, bsw) {
        return qt * (1 - (bsw / 100));
    }

    // Función auxiliar para logaritmo base 10
    function log10(x) {
        return Math.log(x) / Math.log(10);
    }

    // Función para convertir lbm/(ft·s²) a psi
    function lbm_ft_s2_to_psi(value) {
        return value / 144;
    }

    // Función para calcular el Número de Reynolds
    function calcularReynolds(rho, u, D, mu) {
        // Convertir viscosidad de cp a lbm/(ft·s)
        // 1 cp = 0.000672 lbm/(ft·s)
        let mu_ft_s = mu * 0.000672; // lbm/(ft·s)
        return (rho * u * D) / mu_ft_s;
    }

    // Función para calcular el Factor de no-Darcy
    function calcularFactorNoDarcy(Re, C) {
        if (Re < 2000) {
            // Flujo laminar, f_D puede ser insignificante
            return 0;
        } else {
            // Flujo turbulento, usar ecuación de Blasius
            let f = C * 0.0791 * Math.pow(Re, -0.25);
            return f;
        }
    }

    // Función para ajustar un polinomio de grado 2
    function polynomialFit(x, y) {
        let n = x.length;
        let X = [];
        let Y = math.matrix(y);

        for (let i = 0; i < n; i++) {
            X.push([x[i]*x[i], x[i], 1]);
        }

        let X_matrix = math.matrix(X);
        let XT = math.transpose(X_matrix);
        let XTX = math.multiply(XT, X_matrix);
        let XTY = math.multiply(XT, Y);

        let coefficients;
        try {
            coefficients = math.lusolve(XTX, XTY);
        } catch (error) {
            console.error("Error al resolver el sistema lineal:", error);
            return [0, 0, 0];
        }

        // Convertir a array simple
        return coefficients.map(c => c[0]);
    }

    // Función para encontrar las intersecciones entre dos curvas ajustadas
    function findPolynomialIntersection(coeffs1, coeffs2) {
        // Coeficientes de la ecuación cuadrática resultante
        let A = coeffs1.a - coeffs2.a; // a_ipr - a_vfp
        let B = coeffs1.b - coeffs2.b; // b_ipr - b_vfp
        let C = coeffs1.c - coeffs2.c; // c_ipr - c_vfp

        console.log(`Resolviendo intersección: A=${A}, B=${B}, C=${C}`);

        // Discriminante
        let discriminant = B * B - 4 * A * C;
        console.log(`Discriminante: ${discriminant}`);

        let intersectionPoints = [];

        if (discriminant >= 0 && A !== 0) { // A !== 0 para evitar división por cero
            let sqrtDiscriminant = Math.sqrt(discriminant);
            let q1 = (-B + sqrtDiscriminant) / (2 * A);
            let q2 = (-B - sqrtDiscriminant) / (2 * A);

            console.log(`Soluciones: q1=${q1}, q2=${q2}`);

            // Filtrar soluciones válidas (caudales positivos)
            let qSolutions = [q1, q2].filter(q => q >= 0);

            qSolutions.forEach(q => {
                let p = coeffs1.a * q * q + coeffs1.b * q + coeffs1.c;
                intersectionPoints.push({ q, p });
                console.log(`Intersección encontrada: q=${q}, p=${p}`);
            });
        } else {
            console.log("No hay intersecciones válidas.");
        }

        return intersectionPoints;
    }

    // Función para interpolar la curva IPR en una presión dada
    function interpolateIPR(p_wf_ipr, q_ipr, target_pwf) {
        for (let i = 0; i < p_wf_ipr.length - 1; i++) {
            let p1 = p_wf_ipr[i], p2 = p_wf_ipr[i+1];
            let q1 = q_ipr[i], q2 = q_ipr[i+1];

            if ((p1 - target_pwf) * (p2 - target_pwf) <= 0) {
                let q = q1 + (q2 - q1) * (target_pwf - p1) / (p2 - p1);
                console.log(`Interpolación en p_wh=${target_pwf}: q=${q}`);
                return q;
            }
        }
        console.log(`No se encontró interpolación para p_wh=${target_pwf}.`);
        return 0; // Si no se encuentra, asumimos caudal cero
    }

    // Función para obtener datos y realizar cálculos
    function getData() {
        // Validar entradas
        if (!validateInputs()) {
            console.log("Validación de entradas fallida.");
            return null;
        }

        // Obtener datos del formulario
        let p_avg = parseFloat(document.getElementById("p_avg").value); // psi
        let diametros_in = [
            parseFloat(document.getElementById("diametro1").value),
            parseFloat(document.getElementById("diametro2").value),
            parseFloat(document.getElementById("diametro3").value)
        ]; // pulgadas
        let diametros_ft = diametros_in.map(d => d / 12); // Convertir a pies
        let rho = parseFloat(document.getElementById("rho").value); // lbm/ft³
        let p_wh = parseFloat(document.getElementById("p_wh").value); // psi
        let L = parseFloat(document.getElementById("L").value); // ft
        let GOR = parseFloat(document.getElementById("GOR").value); // SCF/bbl
        let API = parseFloat(document.getElementById("API").value); // grados API
        let T = parseFloat(document.getElementById("T").value); // °F
        let gamma_g = parseFloat(document.getElementById("gamma_g").value); // adimensional
        let k = parseFloat(document.getElementById("k").value); // md
        let h = parseFloat(document.getElementById("h").value); // ft
        let re = parseFloat(document.getElementById("re").value); // ft
        let rw_in = parseFloat(document.getElementById("rw").value); // pulgadas
        let rw = rw_in / 12; // Convertir a pies
        let mu_input = parseFloat(document.getElementById("mu").value); // cp
        let C_no_darcy = 1; // Valor demo
        let bubble_correlation = document.getElementById("bubble_correlation").value; // Correlación seleccionada
        let viscosity_correlation = document.getElementById("viscosity_correlation").value; // Correlación seleccionada
        let MD = parseFloat(document.getElementById("MD").value); // ft

        // Datos adicionales
        let company_name = document.getElementById("company_name").value;
        let well_name = document.getElementById("well_name").value;
        let reservoir_name = document.getElementById("reservoir_name").value;
        let analyst_name = document.getElementById("analyst_name").value;
        let analysis_date = document.getElementById("analysis_date").value;

        // Calcular presiones de burbuja con todas las correlaciones
        let bubblePressures = {};
        bubblePressures['Standing'] = 18.2 * Math.pow((GOR / gamma_g) * Math.pow(10, 0.0125 * API), 0.83) * Math.pow(T, -0.5);
        const xGlaso = 0.816 * (Math.log10(GOR / gamma_g) + (0.172 * API) / T);
        bubblePressures['Glaso'] = Math.pow(10, xGlaso / 0.816);
        bubblePressures['Vasquez-Beggs'] = 5.614 * Math.pow((GOR / gamma_g), 0.83) * Math.pow(10, 0.00091 * API) * Math.pow(T, -0.5);
        bubblePressures['Petrosky-Farshad'] = 112.727 * Math.pow((GOR / gamma_g), 0.577) * Math.pow(10, 0.0246 * API) * Math.pow(T, -0.486);

        let presion_burbuja = bubblePressures[bubble_correlation];
        console.log(`Presión de Burbuja (${bubble_correlation}): ${presion_burbuja} psi`);

        // Determinar la viscosidad utilizando la correlación seleccionada
        let viscosity;

        switch(viscosity_correlation) {
            case "Beal":
                viscosity = Math.pow(10, (3.0324 - 0.02023 * API) / Math.pow(T, 1.163));
                break;
            case "Beggs and Robinson":
                viscosity = (Math.pow(10, Math.pow(10, 0.43 + 8.33 / API)) - 1) * Math.pow(T, -1.163);
                break;
            case "Glaso":
                const xVisGlaso = (3.0324 - 0.02023 * API) / Math.pow(T, 1.163);
                viscosity = Math.pow(10, xVisGlaso - 1);
                break;
            case "Petrosky and Farshad":
                viscosity = Math.pow(10, (3.202 - 0.00504 * API) / Math.pow(T, 0.678));
                break;
            default:
                viscosity = mu_input;
        }

        let mu = viscosity;
        console.log(`Viscosidad Calculada: ${mu} cp`);

        // Calcular el Índice de Productividad (PI) usando la ecuación simplificada
        let PI_simplificado = (7.08e-3 * k * h) / (mu * Math.log(re / rw));
        console.log(`Índice de Productividad Simplificado (PI_simplificado): ${PI_simplificado} bbl/(día·psi)`);

        // Calcular el caudal en el punto de burbuja (p_wf = p_b)
        let caudal_burbuja = PI_simplificado * (p_avg - presion_burbuja);
        console.log(`Caudal de Burbuja (q_b): ${caudal_burbuja} bbl/día`);

        // Calcular el caudal máximo (p_wf = 0)
        let q_max = caudal_burbuja + (PI_simplificado * presion_burbuja) / 1.8;
        console.log(`Caudal Máximo del Pozo (q_max): ${q_max} bbl/día`);

        // Calcular la velocidad del fluido (u) para cada diámetro de tubería
        let areas = diametros_ft.map(d => Math.PI * Math.pow(d / 2, 2)); // ft²
        let u_values = areas.map(area => (caudal_burbuja * 5.615) / (24 * 3600 * area)); // ft/s
        console.log(`Velocidades (u) para cada tubería: ${u_values}`);

        // Calcular el Número de Reynolds (Re) para cada diámetro
        let Re_values = u_values.map((u, idx) => calcularReynolds(rho, u, diametros_ft[idx], mu));
        console.log(`Número de Reynolds (Re) para cada tubería: ${Re_values}`);

        // Calcular el Factor de no-Darcy (f_D) usando la constante C proporcionada por el usuario
        let f_D_values = Re_values.map(Re => calcularFactorNoDarcy(Re, C_no_darcy));
        console.log(`Factor de no-Darcy (f_D) para cada tubería: ${f_D_values}`);

        // Ajustar el Índice de Productividad (PI) con f_D y Re (usamos promedios para simplificar)
        let f_D_avg = f_D_values.reduce((a, b) => a + b, 0) / f_D_values.length;
        let Re_avg = Re_values.reduce((a, b) => a + b, 0) / Re_values.length;
        let PI_complejo = PI_simplificado * (1 + (f_D_avg / Math.sqrt(Re_avg)));
        console.log(`Índice de Productividad Complejo (PI_complejo): ${PI_complejo} bbl/(día·psi)`);

        // Calcular el caudal de burbuja y caudal máximo con PI complejo
        let caudal_burbuja_complejo = PI_complejo * (p_avg - presion_burbuja);
        let q_max_complejo = caudal_burbuja_complejo + (PI_complejo * presion_burbuja) / 1.8;
        console.log(`Caudal de Burbuja Complejo (q_b_complejo): ${caudal_burbuja_complejo} bbl/día`);
        console.log(`Caudal Máximo Complejo (q_max_complejo): ${q_max_complejo} bbl/día`);

        // Generar datos de la curva IPR usando el método de Vogel con PI complejo
        let p_wf_ipr = Array.from({length: 50}, (_, i) => p_avg * (1 - 0.2 * (i / 49) - 0.8 * Math.pow(i / 49, 2))); // psi
        let q_ipr = Array.from({length: 50}, (_, i) => q_max_complejo * (1 - 0.2 * (i / 49) - 0.8 * Math.pow(i / 49, 2))); // bbl/día
        console.log(`Datos de la Curva IPR (q_ipr): ${q_ipr}`);
        console.log(`Datos de la Curva IPR (p_wf_ipr): ${p_wf_ipr}`);

        // Generar datos de la curva VFP para cada diámetro
        let g = 32.17; // ft/s²
        let gc = 32.17; // lbm·ft/(lbf·s²)
        let f_F = 0.02; // Factor de fricción (asumido)
        let delta_z = L / 49; // ft

        let vfp_curves = diametros_ft.map((diametro, idx) => {
            let area = areas[idx];
            let q_values = Array.from({length: 50}, (_, i) => q_max_complejo * i / 49); // bbl/día
            let u_vals = q_values.map(q => q * 5.615 / (24 * 3600 * area)); // ft/s

            let p_wf_vfp = u_vals.map(u_val => {
                let term_elevation = lbm_ft_s2_to_psi(rho * delta_z);
                let term_kinetic = lbm_ft_s2_to_psi((rho / (2 * gc)) * Math.pow(u_val, 2));
                let term_friction = lbm_ft_s2_to_psi((2 * f_F * rho * Math.pow(u_val, 2) * L) / diametro);
                return p_wh + term_elevation + term_kinetic + term_friction;
            });

            console.log(`Datos de la Curva VFP - D${idx+1} (q_values): ${q_values}`);
            console.log(`Datos de la Curva VFP - D${idx+1} (p_wf_vfp): ${p_wf_vfp}`);

            return {
                q_values,
                p_wf_vfp,
                diametro_in: diametros_in[idx]
            };
        });

        // Obtener datos de las pruebas
        let test1 = {
            date: document.getElementById("test1_date").value,
            qt: parseFloat(document.getElementById("test1_qt").value),
            bsw: parseFloat(document.getElementById("test1_bsw").value),
            pwf: parseFloat(document.getElementById("test1_pwf").value),
            depth: parseFloat(document.getElementById("test1_depth").value),
            notes: document.getElementById("test1_notes").value
        };

        let test2 = {
            date: document.getElementById("test2_date").value,
            qt: parseFloat(document.getElementById("test2_qt").value),
            bsw: parseFloat(document.getElementById("test2_bsw").value),
            pwf: parseFloat(document.getElementById("test2_pwf").value),
            depth: parseFloat(document.getElementById("test2_depth").value),
            notes: document.getElementById("test2_notes").value
        };

        // Calcular q_o para cada prueba
        test1.qo = calcularQo(test1.qt, test1.bsw);
        test2.qo = calcularQo(test2.qt, test2.bsw);
        console.log(`Caudales de las Pruebas (q_o): Test1=${test1.qo}, Test2=${test2.qo}`);

        // Calcular presión corregida para cada prueba
        let rho_lb_per_gal = rho * 0.13368; // lb/gal
        let delta_depth1 = MD - test1.depth; // ft
        let delta_p1 = 0.052 * rho_lb_per_gal * delta_depth1; // psi
        test1.pwf_corrected = test1.pwf + delta_p1;

        let delta_depth2 = MD - test2.depth; // ft
        let delta_p2 = 0.052 * rho_lb_per_gal * delta_depth2; // psi
        test2.pwf_corrected = test2.pwf + delta_p2;
        console.log(`Presiones Corregidas de las Pruebas (p_wf_corrected): Test1=${test1.pwf_corrected}, Test2=${test2.pwf_corrected}`);

        // Ajuste de la curva IPR
        let iprCoefficients = polynomialFit(q_ipr, p_wf_ipr); // Grado 2
        let [a_ipr, b_ipr, c_ipr] = iprCoefficients; // Coeficientes a, b, c
        console.log(`Coeficientes de Ajuste IPR: a=${a_ipr}, b=${b_ipr}, c=${c_ipr}`);

        // Ajuste de las curvas VFP para cada diámetro
        let vfpCoefficientsArray = vfp_curves.map(curve => {
            let vfpCoefficients = polynomialFit(curve.q_values, curve.p_wf_vfp);
            let [a_vfp, b_vfp, c_vfp] = vfpCoefficients; // Coeficientes a, b, c
            console.log(`Coeficientes de Ajuste VFP - D${curve.diametro_in}: a=${a_vfp}, b=${b_vfp}, c=${c_vfp}`);
            return {
                coefficients: { a: a_vfp, b: b_vfp, c: c_vfp },
                diametro_in: curve.diametro_in
            };
        });

        // Encontrar intersecciones polinomiales
        let polynomialIntersections = vfpCoefficientsArray.map(vfpCurve => {
            let intersectionPoints = findPolynomialIntersection({ a: a_ipr, b: b_ipr, c: c_ipr }, vfpCurve.coefficients);
            return {
                diameter_in: vfpCurve.diametro_in,
                points: intersectionPoints
            };
        });

        // Filtrar intersecciones dentro del rango de caudal de la curva IPR
        let min_q = Math.min(...q_ipr);
        let max_q = Math.max(...q_ipr);
        console.log(`Rango de Caudales IPR: min=${min_q}, max=${max_q}`);

        let intersections = polynomialIntersections.map(intersection => {
            let validPoints = intersection.points.filter(point => 
                point.q >= min_q && point.q <= max_q
            );
            console.log(`Intersecciones válidas para D${intersection.diametro_in}:`, validPoints);
            // Tomar el primer punto válido (puede ajustarse si hay múltiples intersecciones)
            let point = validPoints[0] || { q: null, p: null };
            return {
                diameter_in: intersection.diametro_in,
                q: point.q,
                p: point.p
            };
        });

        // Calcular el caudal en la IPR a la presión de cabeza (p_wh)
        let q_at_pwh = interpolateIPR(p_wf_ipr, q_ipr, p_wh);
        console.log(`Caudal en IPR a p_wh (${p_wh} psi): ${q_at_pwh} bbl/día`);

        let wellFlowsNaturally = q_at_pwh > 0;
        console.log(`¿El pozo fluye naturalmente? ${wellFlowsNaturally}`);

        // Si no fluye naturalmente, calcular delta de presión adicional
        let deltaP_required = p_wh - p_avg;
        if (deltaP_required < 0) deltaP_required = 0;
        console.log(`Delta de Presión Requerida: ${deltaP_required} psi`);

        return {
            p_wf_ipr,
            q_ipr,
            vfp_curves,
            presion_burbuja,
            caudal_burbuja_complejo,
            PI_complejo,
            q_max_complejo,
            mu,
            Re_avg,
            f_D_avg,
            PI_simplificado,
            p_avg,
            bubblePressures,
            bubble_correlation,
            test1,
            test2,
            company_name,
            well_name,
            reservoir_name,
            analyst_name,
            analysis_date,
            p_wh,
            intersections,
            wellFlowsNaturally,
            deltaP_required,
            q_at_pwh,
            iprCoefficients: { a: a_ipr, b: b_ipr, c: c_ipr },
            vfpCoefficientsArray
        };
    }

    // Función para graficar los datos utilizando Plotly
    function plotGraph() {
        let data = getData();
        if (!data) {
            console.log("No se pudo obtener los datos.");
            return;
        }

        let {
            p_wf_ipr,
            q_ipr,
            vfp_curves,
            presion_burbuja,
            caudal_burbuja_complejo,
            PI_complejo,
            q_max_complejo,
            mu,
            Re_avg,
            f_D_avg,
            PI_simplificado,
            p_avg,
            bubblePressures,
            bubble_correlation,
            test1,
            test2,
            company_name,
            well_name,
            reservoir_name,
            analyst_name,
            analysis_date,
            p_wh,
            intersections,
            wellFlowsNaturally,
            deltaP_required,
            q_at_pwh,
            iprCoefficients,
            vfpCoefficientsArray
        } = data;

        // Encontrar el máximo valor de presión para ajustar el eje y
        let max_p = p_avg + 100;
        console.log(`Máximo valor de presión para el eje y: ${max_p} psi`);

        // Curva IPR
        let trace_ipr = {
            x: q_ipr,
            y: p_wf_ipr,
            mode: 'lines',
            name: 'Curva IPR (Vogel)',
            line: {color: 'orange', dash: 'dash'}
        };

        // Curvas VFP para cada tubería
        let vfp_traces = vfp_curves.map((curve, idx) => {
            return {
                x: curve.q_values,
                y: curve.p_wf_vfp,
                mode: 'lines',
                name: `Curva VFP - D${idx+1}=${curve.diametro_in} in`,
                line: {color: ['purple', 'green', 'red'][idx % 3]}
            };
        });

        // Puntos de burbuja de todas las correlaciones
        let bubble_traces = Object.keys(bubblePressures).map(key => {
            return {
                x: [caudal_burbuja_complejo],
                y: [bubblePressures[key]],
                mode: 'markers+text',
                name: `Punto de Burbuja (${key})`,
                text: [key === bubble_correlation ? `${key} (Usada)` : key],
                textposition: 'top right',
                marker: {color: key === bubble_correlation ? 'blue' : 'gray', size: key === bubble_correlation ? 10 : 6}
            };
        });

        // Agregar puntos de las pruebas con presión corregida
        let test_traces = [];
        if (!isNaN(test1.qo) && !isNaN(test1.pwf_corrected)) {
            test_traces.push({
                x: [test1.qo],
                y: [test1.pwf_corrected],
                mode: 'markers+text',
                name: `Prueba 1 (${test1.date})`,
                text: [`Prueba 1`],
                textposition: 'bottom right',
                marker: {color: 'black', size: 10, symbol: 'diamond'}
            });
        }
        if (!isNaN(test2.qo) && !isNaN(test2.pwf_corrected)) {
            test_traces.push({
                x: [test2.qo],
                y: [test2.pwf_corrected],
                mode: 'markers+text',
                name: `Prueba 2 (${test2.date})`,
                text: [`Prueba 2`],
                textposition: 'bottom right',
                marker: {color: 'brown', size: 10, symbol: 'diamond'}
            });
        }

        // Línea horizontal para la presión en cabeza
        let trace_pwh_line = {
            x: [0, q_max_complejo + 100],
            y: [p_wh, p_wh],
            mode: 'lines',
            name: 'Presión en Cabeza (p_wh)',
            line: {color: 'blue', dash: 'dot'}
        };

        // Agregar puntos de intersección al gráfico (aunque las secciones están ocultas)
        let intersectionTraces = intersections.map((intersection, idx) => {
            if (intersection.q !== null && intersection.p !== null) {
                return {
                    x: [intersection.q],
                    y: [intersection.p],
                    mode: 'markers',
                    name: `Intersección D${idx + 1}`,
                    marker: { color: 'red', size: 10, symbol: 'circle' }
                };
            } else {
                return null;
            }
        }).filter(trace => trace !== null);

        // Configuración del gráfico con los rangos establecidos
        let layout = {
            title: `Curvas IPR y VFP - Pozo ${well_name}`,
            xaxis: {
                title: 'Caudal de Flujo (bbl/día)',
                titlefont: {size: 12},
                range: [0, q_max_complejo + 100],
                zeroline: false,
                color: 'black'
            },
            yaxis: {
                title: 'Presión en el Fondo del Pozo (psi)',
                titlefont: {size: 12},
                range: [0, p_avg + 100], // Ajustar el rango dinámicamente a p_avg + 100
                zeroline: false,
                color: 'black'
            },
            showlegend: true,
            responsive: true,
            autosize: true
        };

        // Actualizar o crear el gráfico
        Plotly.newPlot('plot', [trace_ipr, ...vfp_traces, trace_pwh_line, ...bubble_traces, ...test_traces, ...intersectionTraces], layout, {responsive: true});
        console.log("Gráfico actualizado.");

        // Mostrar los resultados en la tabla
        document.getElementById("presion_burbuja").innerText = formatNumber(presion_burbuja);
        document.getElementById("caudal_burbuja").innerText = formatNumber(caudal_burbuja_complejo);
        document.getElementById("indice_productividad_simplificado").innerText = formatNumber(PI_simplificado);
        document.getElementById("indice_productividad_complejo").innerText = formatNumber(PI_complejo);
        document.getElementById("caudal_maximo").innerText = formatNumber(q_max_complejo);
        document.getElementById("viscosidad").innerText = formatNumber(mu);
        document.getElementById("reynolds").innerText = formatNumber(Re_avg);
        document.getElementById("f_darcy").innerText = formatNumber(f_D_avg);

        // Mostrar coeficientes en la sección de resultados adicionales (oculto)
        // document.getElementById("coefficients_ipr").innerText = `a=${formatNumber(iprCoefficients.a)}, b=${formatNumber(iprCoefficients.b)}, c=${formatNumber(iprCoefficients.c)}`;

        vfpCoefficientsArray.forEach((vfpCoeff, idx) => {
            let coeffsText = `a=${formatNumber(vfpCoeff.coefficients.a)}, b=${formatNumber(vfpCoeff.coefficients.b)}, c=${formatNumber(vfpCoeff.coefficients.c)}`;
            document.getElementById(`coefficients_vfp${idx+1}`).innerText = coeffsText;
        });

        // Actualizar la tabla de intersecciones (oculta)
        let intersectionsTableBody = document.getElementById("intersections_table_body");
        intersectionsTableBody.innerHTML = ""; // Limpiar contenido previo

        intersections.forEach(intersection => {
            let row = document.createElement("tr");

            // Diámetro
            let cellDiameter = document.createElement("td");
            cellDiameter.innerText = formatNumber(intersection.diametro_in);
            row.appendChild(cellDiameter);

            // Caudal de intersección
            let cellFlowRate = document.createElement("td");
            if (intersection.q !== null) {
                cellFlowRate.innerText = formatNumber(intersection.q);
            } else {
                cellFlowRate.innerText = "-";
            }
            row.appendChild(cellFlowRate);

            // Presión de intersección
            let cellPressure = document.createElement("td");
            if (intersection.p !== null) {
                cellPressure.innerText = formatNumber(intersection.p);
            } else {
                cellPressure.innerText = "-";
            }
            row.appendChild(cellPressure);

            intersectionsTableBody.appendChild(row);
        });

        // Mostrar Parámetros de operación del pozo
        let naturalFlowResultDiv = document.getElementById("natural_flow_result");
        if (naturalFlowResultDiv) {
            naturalFlowResultDiv.innerHTML = ""; // Limpiar contenido previo

            if (wellFlowsNaturally) {
                naturalFlowResultDiv.innerHTML = `<p><strong>El pozo fluye a flujo natural.</strong> El caudal a la presión de cabeza (${formatNumber(p_wh)} psi) es de ${formatNumber(q_at_pwh)} bbl/día.</p>`;
            } else {
                naturalFlowResultDiv.innerHTML = `<p><strong>El pozo no fluye a flujo natural.</strong></p>`;
                naturalFlowResultDiv.innerHTML += `<p>Se debe diseñar un sistema de levantamiento artificial que genere un delta de presión adicional de ${formatNumber(deltaP_required)} psi para alcanzar la presión de cabeza.</p>`;
            }
        }

        // Llenar las tablas de IPR y VFP
        populateDataTables(data);
    }

    // Función para llenar las tablas IPR y VFP
    function populateDataTables(data) {
        const { p_wf_ipr, q_ipr, vfp_curves } = data;

        // Población de la tabla IPR
        let iprTableBody = document.getElementById("ipr_data_table");
        iprTableBody.innerHTML = ""; // Limpiar contenido previo

        // Limitar la cantidad de filas para mantener la tabla compacta (ejemplo: 10 filas)
        let step_ipr = Math.ceil(p_wf_ipr.length / 10);
        for (let i = 0; i < p_wf_ipr.length; i += step_ipr) {
            let row = document.createElement("tr");
            let cellQ = document.createElement("td");
            let cellP = document.createElement("td");
            cellQ.innerText = formatNumber(q_ipr[i]);
            cellP.innerText = formatNumber(p_wf_ipr[i]);
            row.appendChild(cellQ);
            row.appendChild(cellP);
            iprTableBody.appendChild(row);
        }

        // Población de las tablas VFP individuales
        vfp_curves.forEach((curve, idx) => {
            let tableBodyId = `vfp${idx+1}_data_table`;
            let vfpTableBody = document.getElementById(tableBodyId);
            vfpTableBody.innerHTML = ""; // Limpiar contenido previo

            // Limitar la cantidad de filas para mantener la tabla compacta (ejemplo: 10 filas)
            let step_vfp = Math.ceil(curve.q_values.length / 10);
            for (let i = 0; i < curve.q_values.length; i += step_vfp) {
                let row = document.createElement("tr");
                let cellQ = document.createElement("td");
                let cellP = document.createElement("td");
                cellQ.innerText = formatNumber(curve.q_values[i]);
                cellP.innerText = formatNumber(curve.p_wf_vfp[i]);
                row.appendChild(cellQ);
                row.appendChild(cellP);
                vfpTableBody.appendChild(row);
            }
        });
    }

    // Funciones de exportación
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');

        // Capturar el área que deseamos exportar
        html2canvas(document.querySelector('.container')).then(canvas => {
            let imgData = canvas.toDataURL('image/png');
            let imgWidth = 280;
            let pageHeight = doc.internal.pageSize.getHeight();
            let imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            doc.addImage(imgData, 'PNG', 14, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 14, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // Agregar las anotaciones del usuario (Comentarios y Observaciones)
            let notes = document.getElementById('user_feedback').value;
            if (notes.trim() !== '') {
                doc.addPage();
                doc.setFontSize(12);
                doc.text("Comentarios y Observaciones:", 14, 20);
                doc.setFontSize(10);
                // Dividir el texto en líneas si es necesario
                let lines = doc.splitTextToSize(notes, 280);
                doc.text(lines, 14, 30);
            }

            doc.save('Resultados_IPR_VFP.pdf');
            console.log("Exportación a PDF realizada exitosamente.");
        }).catch(error => {
            console.error("Error al generar el PDF:", error);
        });
    }

    function exportExcel() {
        try {
            // Crear una nueva hoja de cálculo
            let wb = XLSX.utils.book_new();

            // Obtener la tabla de resultados
            let table = document.querySelector('.results-table');
            let ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, "Resultados");

            // Obtener la tabla IPR
            let iprTable = document.querySelector('#ipr_data_table').parentElement.parentElement;
            let ws_ipr = XLSX.utils.table_to_sheet(iprTable);
            XLSX.utils.book_append_sheet(wb, ws_ipr, "Curva IPR");

            // Obtener las tablas VFP
            for (let i = 1; i <= 3; i++) {
                let vfpTable = document.querySelector(`#vfp${i}_data_table`).parentElement.parentElement;
                let ws_vfp = XLSX.utils.table_to_sheet(vfpTable);
                XLSX.utils.book_append_sheet(wb, ws_vfp, `Curva VFP ${i}`);
            }

            // Guardar el libro
            XLSX.writeFile(wb, 'Resultados_IPR_VFP.xlsx');
            console.log("Exportación a Excel realizada exitosamente.");
        } catch (error) {
            console.error("Error al exportar a Excel:", error);
        }
    }

    // Función para enviar comentarios (simulada)
    function submitFeedback() {
        let email = document.getElementById('user_email').value;
        let feedback = document.getElementById('user_feedback').value;

        if (feedback.trim() === '') {
            alert('Por favor, ingrese sus comentarios antes de enviar.');
            return;
        }

        // Simulación de envío de comentarios
        alert('¡Gracias por tus comentarios!');

        // Limpiar el formulario
        document.getElementById('feedbackForm').reset();
    }

    // Event listeners
    document.querySelectorAll('input, select, textarea').forEach(input => input.addEventListener('input', plotGraph));

    // Plot inicial y establecer fecha actual
    window.onload = function() {
        // Establecer la fecha actual
        let today = new Date().toISOString().substr(0, 10);
        document.getElementById('analysis_date').value = today;

        // Graficar
        plotGraph();
    };
</script>

</body>
</html>
